#!/bin/bash

if [ -n "$CI" ]; then
  echo "== Installing system packages =="
  sudo apt-get update
  sudo apt-get install -y libcurl4-openssl-dev
  echo
fi

gem_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." &>/dev/null && pwd)"
spec_manageiq="$gem_root/spec/manageiq"

if [ -n "$MANAGEIQ_REPO" ]; then
  echo "== Symlinking spec/manageiq to $MANAGEIQ_REPO =="
  rm -rf "$spec_manageiq"
  ln -s "$(cd "$MANAGEIQ_REPO" &>/dev/null && pwd)" "$spec_manageiq"
elif [ ! -d "$spec_manageiq" ]; then
  echo "== Cloning manageiq sample app =="
  git clone https://github.com/ManageIQ/manageiq.git --branch oparin --depth 1 "$spec_manageiq"
fi

if [ -n "$CI" ]; then
  # Gemfile.lock.release only applies to non-master branches and PRs to non-master branches
  if [[ "$GITHUB_REPOSITORY_OWNER" = "ManageIQ" && "$GITHUB_BASE_REF" != "master" && "$GITHUB_REF_NAME" != "master" && "$GITHUB_REF_NAME" != "dependabot/"* ]]; then
    echo "== Setup Gemfile.lock.release =="
    cp -f "$spec_manageiq/Gemfile.lock.release" "$gem_root/Gemfile.lock"

    $spec_manageiq/bin/ci/patch_plugin_gemfile_lock
    echo
  fi
fi
